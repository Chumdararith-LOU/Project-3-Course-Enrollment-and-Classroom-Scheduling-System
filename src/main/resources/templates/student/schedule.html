<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>My Schedule | Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* SCROLLBAR STYLING */
        #schedule-scroll-area::-webkit-scrollbar { width: 8px; height: 8px; }
        #schedule-scroll-area::-webkit-scrollbar-track { background: #f1f5f9; }
        #schedule-scroll-area::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        #schedule-scroll-area::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* GRID SETUP */
        .timetable-wrapper {
            display: grid;
            /* Time Column (60px) + 6 Days */
            grid-template-columns: 60px repeat(6, minmax(140px, 1fr));
            /* Header (40px) + 12 Hours (60px each) */
            grid-template-rows: 40px repeat(12, 60px);
            position: relative;
            background-color: #fff;
            border: 1px solid #e2e8f0;
        }

        /* 1. CORNER (Top-Left) */
        .corner-cell {
            position: sticky; top: 0; left: 0; z-index: 50;
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
        }

        /* 2. HEADERS (Days) */
        .header-cell {
            position: sticky; top: 0; z-index: 40;
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
            font-weight: 600; font-size: 0.85rem; color: #475569;
            display: flex; align-items: center; justify-content: center;
        }

        /* 3. TIME LABELS (Left Column) - FIXED ALIGNMENT */
        .time-cell {
            grid-column: 1;
            position: sticky; left: 0; z-index: 30;
            background-color: #fff;
            border-right: 1px solid #e2e8f0; /* Continuous vertical line */
            height: 60px;

            /* Align content to the TOP right */
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
            padding-right: 8px;
        }

        /* The magic fix: Move the text up by 50% of its own height
           so it sits CENTERED on the grid line */
        .time-cell > span {
            transform: translateY(-50%);
            display: block;
            background-color: #fff; /* Optional: Masks the line behind text for cleaner look */
            padding-left: 4px;
            font-size: 0.75rem;
            color: #94a3b8;
        }

        /* 4. BACKGROUND GRID LINES */
        .grid-line {
            border-bottom: 1px solid #f1f5f9;
            border-right: 1px solid #f1f5f9;
            height: 100%; width: 100%;
        }

        /* 5. EVENT CARDS */
        .event-card {
            position: absolute;
            width: 94%; left: 3%;
            padding: 8px 10px; border-radius: 6px;
            font-size: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid;
            transition: all 0.2s; z-index: 10; cursor: pointer;
            overflow: hidden; display: flex; flex-direction: column; justify-content: center;
        }
        .time-cell-start > span {
            transform: translateY(0) !important; /* Don't shift it up */
            position: relative;
            top: -4px; /* Slight adjustment to tuck it right under the header line */
        }
        .event-card:hover { z-index: 50; transform: scale(1.02); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }

        /* COLORS */
        .card-purple { background-color: #f3e8ff; border-color: #9333ea; color: #6b21a8; }
        .card-blue   { background-color: #dbeafe; border-color: #2563eb; color: #1e40af; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 overflow-hidden">
<div class="flex h-screen">

    <div th:replace="~{fragments/student-sidebar :: sidebar(currentPage='schedule')}"></div>

    <main class="flex-1 flex flex-col h-screen relative">
        <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-8 z-20 shrink-0 shadow-sm">
            <h1 class="text-xl font-bold text-slate-800">Weekly Timetable</h1>
            <div class="text-sm text-gray-500 flex gap-4">
                <span class="flex items-center"><div class="w-3 h-3 rounded-sm bg-purple-100 border border-purple-600 mr-2"></div> Lecture</span>
                <span class="flex items-center"><div class="w-3 h-3 rounded-sm bg-blue-100 border border-blue-600 mr-2"></div> Lab</span>
            </div>
        </header>

        <div class="flex-1 overflow-auto p-6 bg-slate-50" id="schedule-scroll-area">
            <div class="timetable-wrapper shadow-sm rounded-lg overflow-hidden" id="timetable">

                <div class="corner-cell"></div>

                <div class="header-cell">MON</div>
                <div class="header-cell">TUE</div>
                <div class="header-cell">WED</div>
                <div class="header-cell">THU</div>
                <div class="header-cell">FRI</div>
                <div class="header-cell">SAT</div>

                <th:block th:each="hour, iterStat : ${#numbers.sequence(7, 18)}">

                    <div class="time-cell"
                         th:classappend="${iterStat.first} ? 'time-cell-start' : ''"
                         th:style="'grid-row: ' + ${hour - 7 + 2} + ';'">

                        <span th:text="${hour} + ':00'">7:00</span>
                    </div>

                    <div class="grid-line" th:each="d : ${#numbers.sequence(1,6)}"></div>
                </th:block>

                <div th:each="sched, iterStat : ${schedules}"
                     class="event-card group"
                     th:classappend="${iterStat.index % 2 == 0 ? 'card-purple' : 'card-blue'}"
                     th:data-day="${sched.dayOfWeek}"
                     th:data-start="${sched.startTime}"
                     th:data-end="${sched.endTime}">

                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold truncate text-[11px] uppercase tracking-wide opacity-70" th:text="${sched.roomNumber}">Room</span>
                    </div>
                    <div class="font-bold text-sm leading-tight mb-1 line-clamp-2" th:text="${sched.courseName}">Course</div>
                    <div class="text-[10px] font-semibold opacity-80 flex items-center gap-1">
                        <i class="far fa-clock"></i>
                        <span th:text="${#strings.substring(sched.startTime,0,5)}">08:00</span> -
                        <span th:text="${#strings.substring(sched.endTime,0,5)}">09:30</span>
                    </div>
                </div>

            </div>
        </div>
    </main>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const startHour = 7;
        const hourPx = 60;
        const headerPx = 40;

        const dayMap = { 'MON': 2, 'TUE': 3, 'WED': 4, 'THU': 5, 'FRI': 6, 'SAT': 7 };

        const cards = document.querySelectorAll('.event-card');

        cards.forEach(card => {
            const day = card.getAttribute('data-day');
            const startTime = card.getAttribute('data-start');
            const endTime = card.getAttribute('data-end');

            if (dayMap[day]) {
                const colIndex = dayMap[day];
                const [startH, startM] = startTime.split(':').map(Number);
                const [endH, endM] = endTime.split(':').map(Number);

                card.style.gridColumnStart = colIndex;
                card.style.gridColumnEnd = "span 1";

                // Position Calculation
                const topPosition = headerPx + ((startH - startHour) * hourPx) + ((startM / 60) * hourPx);
                const durationMinutes = ((endH * 60) + endM) - ((startH * 60) + startM);
                const heightPx = (durationMinutes / 60) * hourPx;

                // Add 1px offset to topPosition to avoid overlapping the exact border line if preferred
                card.style.top = (topPosition + 1) + "px";
                card.style.height = (heightPx - 2) + "px"; // Subtract 2px for visual gap

                card.style.display = 'flex';
            }
        });
    });
</script>
</body>
</html>